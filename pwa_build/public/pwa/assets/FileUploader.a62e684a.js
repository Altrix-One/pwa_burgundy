var p=(r,e,s)=>new Promise((o,a)=>{var t=l=>{try{i(s.next(l))}catch(d){a(d)}},n=l=>{try{i(s.throw(l))}catch(d){a(d)}},i=l=>l.done?o(l.value):Promise.resolve(l.value).then(t,n);i((s=s.apply(r,e)).next())});import{p as h,o as f,b as c,d as g,Q as m,R as _,S as F}from"./index.0e3c50f7.js";class y{constructor(){this.listeners={},this.failed=!1}on(e,s){this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(s)}trigger(e,s){(this.listeners[e]||[]).forEach(a=>{a.call(this,s)})}upload(e,s){return new Promise((o,a)=>{let t=new XMLHttpRequest;t.upload.addEventListener("loadstart",()=>{this.trigger("start")}),t.upload.addEventListener("progress",l=>{l.lengthComputable&&this.trigger("progress",{uploaded:l.loaded,total:l.total})}),t.upload.addEventListener("load",()=>{this.trigger("finish")}),t.addEventListener("error",()=>{this.trigger("error"),a()}),t.onreadystatechange=()=>{if(t.readyState==XMLHttpRequest.DONE){let l;if(t.status===200){let d=null;try{d=JSON.parse(t.responseText)}catch(w){d=t.responseText}let u=d.message||d;o(u)}else if(t.status===403)l=JSON.parse(t.responseText);else{this.failed=!0;try{l=JSON.parse(t.responseText)}catch(d){}}l&&l.exc&&console.error(JSON.parse(l.exc)[0]),a(l)}};const n=s.upload_endpoint||"/api/method/upload_file";t.open("POST",n,!0),t.setRequestHeader("Accept","application/json"),window.csrf_token&&window.csrf_token!=="{{ csrf_token }}"&&t.setRequestHeader("X-Frappe-CSRF-Token",window.csrf_token);let i=new FormData;e&&i.append("file",e,e.name),i.append("is_private",s.private?"1":"0"),i.append("folder",s.folder||"Home"),s.file_url&&i.append("file_url",s.file_url),s.doctype&&i.append("doctype",s.doctype),s.docname&&i.append("docname",s.docname),s.fieldname&&i.append("fieldname",s.fieldname),s.method&&i.append("method",s.method),s.type&&i.append("type",s.type),t.send(i)})}}const S={name:"FileUploader",props:["fileTypes","uploadArgs","validateFile"],data(){return{uploader:null,uploading:!1,uploaded:0,error:null,message:"",total:0,file:null,finishedUploading:!1}},computed:{progress(){let r=Math.floor(this.uploaded/this.total*100);return isNaN(r)?0:r},success(){return this.finishedUploading&&!this.error}},methods:{inputRef(){return this.$refs.input},openFileSelector(){this.$refs.input.click()},onFileAdd(r){return p(this,null,function*(){if(this.error=null,this.file=r.target.files[0],this.file&&this.validateFile)try{let e=yield this.validateFile(this.file);e&&(this.error=e)}catch(e){this.error=e}this.error||this.uploadFile(this.file)})},uploadFile(r){return p(this,null,function*(){this.error=null,this.uploaded=0,this.total=0,this.uploader=new y,this.uploader.on("start",()=>{this.uploading=!0}),this.uploader.on("progress",e=>{this.uploaded=e.uploaded,this.total=e.total}),this.uploader.on("error",()=>{this.uploading=!1,this.error="Error Uploading File"}),this.uploader.on("finish",()=>{this.uploading=!1,this.finishedUploading=!0}),this.uploader.upload(r,this.uploadArgs||{}).then(e=>{this.$emit("success",e)}).catch(e=>{this.uploading=!1;let s="Error Uploading File";e!=null&&e._server_messages?s=JSON.parse(JSON.parse(e._server_messages)[0]).message:e!=null&&e.exc&&(s=JSON.parse(e.exc)[0].split(`
`).slice(-2,-1)[0]),this.error=s,this.$emit("failure",e)})})}},expose:["inputRef"]},v=["accept"];function x(r,e,s,o,a,t){return f(),c("div",null,[g("input",{ref:"input",type:"file",accept:s.fileTypes,class:"hidden",onChange:e[0]||(e[0]=(...n)=>t.onFileAdd&&t.onFileAdd(...n))},null,40,v),m(r.$slots,"default",_(F({file:a.file,uploading:a.uploading,progress:t.progress,uploaded:a.uploaded,message:a.message,error:a.error,total:a.total,success:t.success,openFileSelector:t.openFileSelector})))])}var O=h(S,[["render",x]]);export{O as F};
